name: Automated Code Review Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # 1Ô∏è‚É£ Checkout repository
      # --------------------------------------------------
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # 2Ô∏è‚É£ Setup Python
      # --------------------------------------------------
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      # --------------------------------------------------
      # 3Ô∏è‚É£ Install dependencies
      # --------------------------------------------------
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch transformers datasets scikit-learn
          pip install pylint flake8 bandit
          pip install tree-sitter==0.20.4
          pip install tree-sitter-languages==1.10.2
          pip install huggingface_hub safetensors

      # --------------------------------------------------
      # 4Ô∏è‚É£ Verify HF_TOKEN exists (FAIL EARLY)
      # --------------------------------------------------
      - name: üîç Verify Hugging Face token
        run: |
          if [ -z "${{ secrets.HF_TOKEN }}" ]; then
            echo "‚ùå HF_TOKEN secret is missing"
            exit 1
          else
            echo "‚úÖ HF_TOKEN secret detected"
          fi

      # --------------------------------------------------
      # 5Ô∏è‚É£ Login to Hugging Face (CORRECT WAY)
      # --------------------------------------------------
      - name: üîê Login to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python - <<'EOF'
          import os
          from huggingface_hub import login

          token = os.environ.get("HF_TOKEN")

          if not token:
              raise RuntimeError("HF_TOKEN not available inside Python")

          login(token=token)
          print("‚úÖ Hugging Face login successful")
          EOF

      # --------------------------------------------------
      # 6Ô∏è‚É£ Run integration tests
      # --------------------------------------------------
      - name: üß™ Run integration tests (CI Enforcement)
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          python test_integration.py --ci

      # --------------------------------------------------
      # 7Ô∏è‚É£ Analyze Pull Request code
      # --------------------------------------------------
      - name: üîç Analyze Pull Request Code
        if: github.event_name == 'pull_request'
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          python src/pr_analyze.py
