name: Automated Code Review Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # 1ï¸âƒ£ Checkout repository
      # --------------------------------------------------
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # 2ï¸âƒ£ Setup Python
      # --------------------------------------------------
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      # --------------------------------------------------
      # 3ï¸âƒ£ Install dependencies
      # --------------------------------------------------
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch transformers datasets scikit-learn
          pip install pylint flake8 bandit
          pip install tree-sitter==0.20.4
          pip install tree-sitter-languages==1.10.2
          pip install huggingface_hub safetensors

      # --------------------------------------------------
      # 4ï¸âƒ£ Login to Hugging Face
      # ğŸ”’ Runs ONLY when secrets are available
      # --------------------------------------------------
      - name: ğŸ” Login to Hugging Face
        if: github.event_name == 'push'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python - <<'EOF'
          import os
          from huggingface_hub import login

          token = os.environ.get("HF_TOKEN")
          if not token:
              raise RuntimeError("HF_TOKEN is missing")

          login(token=token)
          print("âœ… Hugging Face login successful")
          EOF

      # --------------------------------------------------
      # 5ï¸âƒ£ Run integration tests
      # --------------------------------------------------
      - name: ğŸ§ª Run integration tests (CI Enforcement)
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          python test_integration.py --ci

      # --------------------------------------------------
      # 6ï¸âƒ£ Analyze Pull Request code
      # --------------------------------------------------
      - name: ğŸ” Analyze Pull Request Code
        if: github.event_name == 'pull_request'
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          python src/pr_analyze.py
