name: Automated Code Review Pipeline

on:
  pull_request:
    branches: [ "main", "master" ]

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------
    # 1Ô∏è‚É£ Checkout PR code
    # --------------------------------------------------
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # --------------------------------------------------
    # 2Ô∏è‚É£ Setup Python
    # --------------------------------------------------
    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.9"

    # --------------------------------------------------
    # 3Ô∏è‚É£ Install dependencies
    # --------------------------------------------------
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch transformers datasets scikit-learn
        pip install pylint flake8 bandit
        pip install tree-sitter==0.20.4 tree-sitter-languages==1.10.2
        pip install huggingface_hub safetensors

    # --------------------------------------------------
    # 4Ô∏è‚É£ Hugging Face login (safe - only for same repo)
    # --------------------------------------------------
    - name: üîê Login to Hugging Face
      if: github.event.pull_request.head.repo.full_name == github.repository
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python - <<'EOF'
        import os
        from huggingface_hub import login
        token = os.environ.get("HF_TOKEN")
        if token:
            login(token=token)
            print("‚úÖ Hugging Face login successful")
        else:
            print("‚ö†Ô∏è No HF_TOKEN available, will use public access")
        EOF

    # --------------------------------------------------
    # 5Ô∏è‚É£ Download model ONCE (shared)
    # --------------------------------------------------
    - name: ‚¨áÔ∏è Download vulnerability model
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python scripts/download_model.py

    # --------------------------------------------------
    # 6Ô∏è‚É£ Run INTEGRATION TESTS FIRST
    # --------------------------------------------------
    - name: üß™ Run integration tests
      env:
        PYTHONPATH: ${{ github.workspace }}/src
      run: |
        python test_integration.py --ci

    # --------------------------------------------------
    # 7Ô∏è‚É£ Analyze PR CODE (REAL DECISION)
    # --------------------------------------------------
    - name: üîç Analyze Pull Request code
      env:
        PYTHONPATH: ${{ github.workspace }}/src
      run: |
        python src/pr_analyze.py
