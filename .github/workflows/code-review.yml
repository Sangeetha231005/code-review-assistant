name: Automated Code Review Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # 1ï¸âƒ£ Checkout repository
      # --------------------------------------------------
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # 2ï¸âƒ£ Setup Python
      # --------------------------------------------------
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      # --------------------------------------------------
      # 3ï¸âƒ£ Install dependencies
      # --------------------------------------------------
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch transformers datasets scikit-learn
          pip install pylint flake8 bandit
          pip install tree-sitter==0.20.4
          pip install tree-sitter-languages==1.10.2
          pip install huggingface_hub safetensors

      # --------------------------------------------------
      # 4ï¸âƒ£ Hugging Face Login (ONLY WHEN SAFE)
      #     - Push to main/master âœ…
      #     - PR from same repo âœ…
      #     - Forked PR âŒ (skipped automatically)
      # --------------------------------------------------
      - name: ðŸ” Login to Hugging Face
        if: >
          github.event_name == 'push' ||
          (github.event_name == 'pull_request' &&
           github.event.pull_request.head.repo.full_name == github.repository)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python - <<'EOF'
          import os
          from huggingface_hub import login

          token = os.environ.get("HF_TOKEN")
          if not token:
              raise RuntimeError("HF_TOKEN missing in trusted CI")

          login(token=token)
          print("âœ… Hugging Face login successful")
          EOF

      # --------------------------------------------------
      # 5ï¸âƒ£ Run integration tests
      # --------------------------------------------------
      - name: ðŸ§ª Run integration tests
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          python test_integration.py --ci

      # --------------------------------------------------
      # 6ï¸âƒ£ Analyze Pull Request code
      # --------------------------------------------------
      - name: ðŸ” Analyze Pull Request Code
        if: github.event_name == 'pull_request'
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          python src/pr_analyze.py
